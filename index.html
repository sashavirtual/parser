<body>
    <div class="form">
        <textarea placeholder="Введите результаты..."></textarea>
        <p>Заездов для зачёта</p>
        <select id="select">
        </select>
        <button>Подвести итоги</button>
    </div>
    <button id="excel"> Копировать результаты в Excel Формате</button>
    <div id="tableSpeed">
        <div id="firstRow">
            <div class="name">Игрок</div>
        </div>
    </div>
    <p id="duels">

    </p>


</body>
<style>
    :root {
        --border: 1px solid rgb(103, 103, 103);
        --inputBG: rgb(237, 237, 237);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    #tableSpeed {}

    #firstRow {
        display: flex;
        flex-direction: row;
    }

    #raceQuantity,
    #select {
        max-width: 100px;
        margin-bottom: 15px;
        background-color: var(--inputBG);
    }

    body {
        padding: 5vh 5vw;
        background-color: rgb(212, 212, 212);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .form {
        display: flex;
        flex-direction: column;
        margin: 20px;
    }

    .form button {
        background-color: var(--inputBG);
        border: none;
        cursor: pointer;
        transition: 0.2s;
        padding: 5px;
    }

    .form button:hover {
        background-color: rgb(209, 205, 243);
    }

    textarea {
        min-width: 800px;
        min-height: 100px;
        background-color: var(--inputBG);

    }

    #excel {
        padding: 5px;
        margin: 0 0 10px 0;
        transition: 0.2s;
        cursor: pointer;
        border: 1px solid rgb(72, 72, 72);
        border-radius: 2px;
    }

    #excel:hover {
        background-color: rgb(203, 255, 191);
    }

    .name {
        min-width: 150px;
        width: 150px;
        border: var(--border);
        padding: 3px 0 3px 5px;

    }

    .row {
        display: flex;
        flex-direction: row;
        max-width: 150px;
    }

    .rang7 {
        background-color: rgb(0, 160, 160);
    }

    .column {
        width: 30px;
        padding: 2px;
        border: var(--border);
        margin: 0;
        text-align: center;
        min-width: 30px;
    }

    .average {
        min-width: 55px;
        padding: 2px;
        border: var(--border);
        margin: 0;
        text-align: center;
    }

    .rang1 {
        background-color: #8D8D8D;
    }

    .rang2 {
        background-color: rgb(153, 255, 241);

    }

    .rang3 {
        background-color: rgb(163, 255, 153);

    }

    .rang4 {
        background-color: rgb(255, 255, 153);

    }

    .rang5 {
        background-color: rgb(255, 204, 153);

    }

    .rang6 {
        background-color: rgb(255, 153, 204);

    }

    .rang7 {
        background-color: rgb(204, 154, 255);
    }

    .rang8 {
        background-color: rgb(153, 204, 255);

    }

    .rang9 {
        background-color: rgb(20, 26, 135);
        color: rgb(237, 237, 237)
    }

    .competing {}

    .notCompeting {
        filter: brightness(0.7);
        display: none;
    }

    #duels {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        max-width: 730px;
        border: 1px solid black;
        margin: 10px;
    }

    .duelyant {
        font-weight: 1000;
        padding: 10px;
    }

    .duelyant div {
        font-weight: 400;
        width: 160px;
    }

    .won {
        color: rgb(0, 164, 0);
    }

    .lost {
        color: rgb(184, 0, 21);
    }

    .flawlessV {
        color: rgb(0, 21, 209);

    }

    .flawlessL {
        color: rgb(184, 0, 21);
    }

    .hidden {
        display: none;
    }
</style>
<script>
    let select = document.querySelector('#select')
    for (let i = 0; i < 20; i++) {
        let option = document.createElement('option')
        option.textContent = String(i + 1)
        select.appendChild(option)
    }
    let everyone
    function resultsScriptFunction(data, quantity = 0) {
        let firstRow = document.querySelector("#firstRow")

        // Создаём первый ряд с количеством заездов
        for (let index = 0; index <= data.length; index++) {
            let div = document.createElement('div')
            firstRow.appendChild(div)
            div.classList.add("column")

            if (index === data.length) {
                div.textContent = "Средн."
                div.classList.add('average')
                continue
            } else {
                div.textContent = index + 1
            }
        }

        // Создаём список всех игроков из всех заездов
        let allPlayers = [...new Set(data.map(race => Object.keys(race)).reduce((a, b) => a.concat(b)))]
        everyone = allPlayers.slice(0)

        // Выделяем список игроков, ранжированный по средней скорости 
        allPlayers = allPlayers.map((player, i) => {
            let averageSpeed = 0, rang = 'rang1'
            let aboveZero = 0
            data.map((race, index) => {
                if (data[index][player]) {
                    averageSpeed += data[index][player]["speed"]
                    rang = data[index][player]["rang"]
                    aboveZero++
                }
                return averageSpeed
            })

            //сколько требуется доездов для зачёта

            if (aboveZero >= quantity) {
                isCompeting = true
            } else {
                isCompeting = false
            }
            // (включая нули) averageSpeed/data.length || (исключая нули) averageSpeed/aboveZero 
            //['sashavirtual', 450.06, 'rang7', 18, true]
            // aboveZero = data.length //раскомментировать если нужно по всем заездам турнира
            return [player, (averageSpeed / aboveZero).toFixed(2), rang, aboveZero, isCompeting]

            //Сортировка по количеству доездов [1] - скорость
        }).sort((a, b) => b[1] - a[1])

        for (let i = 0; i < allPlayers.length; i++) {
            let tableSpeed = document.querySelector('#tableSpeed')
            let tr = document.createElement('div')
            let rang = allPlayers[i][2]
            tr.classList.add('row', rang)
            if (!allPlayers[i][4]) {
                tr.classList.add('notCompeting')
            } else {
                tr.classList.add('competing')
            }
            tableSpeed.appendChild(tr)
            let nameElement = document.createElement('div')
            tr.appendChild(nameElement)
            //можно вставить ${i + 1}. 
            nameElement.textContent = `${allPlayers[i][0]}`
            nameElement.classList.add('name', rang)

            // Создаётся массив со скоростями, итерации каждого игрока по объекту с данными
            let speedsArr = []
            for (let j = 0; j <= data.length; j++) {
                if (j == data.length) {
                    let averageSpeed = (speedsArr.reduce((a, b) => a + b) / allPlayers[i][3]).toFixed(2)
                    let averageElement = document.createElement('div')
                    tr.appendChild(averageElement)
                    averageElement.textContent = String(averageSpeed)
                    averageElement.classList.add('average', rang)
                    continue
                }
                let raceSpeed
                if (data[j][allPlayers[i][0]]) {
                    raceSpeed = data[j][allPlayers[i][0]]["speed"]
                } else {
                    raceSpeed = 0
                }
                speedsArr.push(raceSpeed)
                let speedElement = document.createElement('div')
                tr.appendChild(speedElement)
                speedElement.textContent = String(raceSpeed)
                speedElement.classList.add('column', rang)
            }
        }

        //------------------------------------------------------------------------------//

        // РЕЗУЛЬТАТЫ ДУЭЛЕЙ
        let allDuels = {}

        // Создаётся обнулённый объект всех возможных дуэлей
        for (let i = 0; i < everyone.length; i++) {
            allDuels[everyone[i]] = {}
            for (let j = 0; j < everyone.length; j++) {
                if (i !== j) {
                    allDuels[everyone[i]][everyone[j]] = [0, 0];
                }
            }
        }

        // Объект заполняется данными
        for (let race = 0; race < data.length; race++) {
            for (let plMain = 0; plMain < everyone.length; plMain++) {
                let pl1 = everyone[plMain]
                if (data[race][pl1]) {
                    for (let plIterable = plMain + 1; plIterable < everyone.length; plIterable++) {
                        if (plMain !== plIterable) {
                            let pl2 = everyone[plIterable]
                            if (data[race][pl2]) {
                                let plMS = data[race][everyone[plMain]]["speed"]
                                let plIS = data[race][everyone[plIterable]]["speed"]
                                //player Main and Iterable speeds
                                if (plMS > plIS) {
                                    allDuels[pl1][pl2][0] += 1;
                                    allDuels[pl2][pl1][1] += 1;
                                } else if (plMS < plIS) {
                                    allDuels[pl1][pl2][1] += 1;
                                    allDuels[pl2][pl1][0] += 1;

                                }
                            }
                        }
                    }
                }
            }
        }

        // Данные переносятся на HTML, присваиваются CSS-классы
        for (let i = 0; i < everyone.length; i++) {
            let duels = document.querySelector('#duels')
            let div = document.createElement('div')
            div.classList.add('duelyant')
            div.textContent = everyone[i] + '\n'
            for (const duel in allDuels[everyone[i]]) {
                let div2 = document.createElement('div')
                div2.textContent = JSON.stringify(`${duel} (${allDuels[everyone[i]][duel]})`).replace(/[\{\}]/ig, '').replace(/,\"/ig, ",\n\"").replace(/\"/ig, "").replace(',', ':')
                let res = div2.textContent.replace(/.+\(/ig, ' ').replace(/\)/ig, '').replace(/\s/ig, '').split(':').map(item => +item)
                if (res[0] == 15) {
                    div2.classList.add('flawlessV')
                } else if (res[1] == 15) {
                    div2.classList.add('flawlessL')
                } else if (res[0] > res[1]) {
                    div2.classList.add('won')
                } else if (res[1] > res[0]) {
                    div2.classList.add('lost')
                }
                if (res[0] === 0 && res[1] === 0) {
                    div2.classList.add('hidden')
                }
                div.appendChild(div2)
            }
            duels.appendChild(div)
        }

    }

    // Копировать результаты в буфер обмена для Excel
    function copyToClipboard() {
        let txtArr = []
        let table = document.querySelector("#tableSpeed")
        // let row = document.querySelectorAll(".row")
        // console.log(row,'row')
        // console.log(column,'column')
        let i = 0
        for (const row of table.children) {
            txtArr.push(new Array)

            for (const cell of row.children) {
                txtArr[i].push(cell.textContent)
            }
            if (i) txtArr[i][txtArr[i].length - 1] = txtArr[i][txtArr[i].length - 1].replace(/.+/ig, `=AVERAGEIF(D${i + 2}:R${i + 2};">0")`)
            txtArr[i] = txtArr[i].join('\t')
            i++
        }
        navigator.clipboard.writeText(txtArr.join('\n'))
    }

    document.querySelector('#excel').addEventListener('click', copyToClipboard)

    function funcCall() {
        let textarea = document.querySelector("body > div.form > textarea").value.replace(/[\n\t\s]/ig, '')
        let data = JSON.parse(`[${textarea.trim()}]`)
        let pass = +document.querySelector("#select").value.replace(/[\n\t\s]/ig, '')
        resultsScriptFunction(data, pass)
    }
    let funcCallButton = document.querySelector("body > div.form > button")
    funcCallButton.addEventListener('click', funcCall)
</script>