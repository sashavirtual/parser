<body>
    <div class="form">
        <textarea placeholder="Введите результаты..."></textarea>
        <div class="flexSelects">
            <div>
                <p>Заездов для зачёта</p>
                <select id="selectPass">
                </select>
            </div>
            <button id="showScores">Подвести итоги</button>
            <div>
                <p>Топ-N скоростей</p>
                <select id="selectTop">
                    <option>Неважно</option>
                </select>
            </div>
        </div>
    </div>
    </div>
    <button id="excelSpeed"> Копировать результаты в Excel Формате (Скорости)</button>
    <div id="tableSpeed">
        <div id="firstRowSpeed">
            <div class="name">Игрок</div>
        </div>
    </div>
    <br />
    <button id="excelErrors"> Копировать результаты в Excel Формате (Ошибки)</button>
    <div id="tableErrors">
        <div id="firstRowErrors">
            <div class="name">Игрок</div>
        </div>
    </div>
    <br />
    <button id="excelErrorPercentage"> Копировать результаты в Excel Формате (% ошибок)</button>
    <div id="tableErrorPercentage">
        <div id="firstRowErrorPercentage">
            <div class="name">Игрок</div>
        </div>
    </div>
    <br />
    <button id="excelTime"> Копировать результаты в Excel Формате (Время)</button>
    <div id="tableTime">
        <div id="firstRowTime">
            <div class="name">Игрок</div>
        </div>
    </div>
    <p id="duels">

    </p>


</body>
<style>
    :root {
        --border: 1px solid rgb(103, 103, 103);
        --inputBG: rgb(237, 237, 237);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    #firstRowSpeed,
    #firstRowErrors,
    #firstRowTime,
    #firstRowErrorPercentage {
        display: flex;
        flex-direction: row;
    }

    .flexSelects {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
    }

    .flexSelects>div {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .flexSelects>div>select {
        margin: 10px;
        min-width: 40px;
    }


    #raceQuantity,
    #selectPass,
    #selectTop {
        max-width: 100px;
        margin-bottom: 15px;
        background-color: var(--inputBG);
    }

    body {
        padding: 5vh 5vw;
        background-color: rgb(222, 222, 222);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .form {
        display: flex;
        flex-direction: column;
        margin: 20px;
    }

    #showScores {
        background-color: var(--inputBG);
        border: none;
        cursor: pointer;
        transition: 0.2s;
        font-size: 20px;
        padding: 10px;
        margin: 25px;
    }

    #showScores:hover {
        background-color: rgb(209, 205, 243);
    }

    textarea {
        min-width: 800px;
        min-height: 100px;
        background-color: var(--inputBG);

    }

    #excelSpeed,
    #excelErrors,
    #excelErrorPercentage,
    #excelTime {
        padding: 5px;
        margin: 0 0 10px 0;
        transition: 0.2s;
        cursor: pointer;
        border: 1px solid rgb(72, 72, 72);
        border-radius: 2px;
    }

    #excelSpeed:hover,
    #excelErrors:hover,
    #excelErrorPercentage:hover,
    #excelTime:hover {
        background-color: rgb(203, 255, 191);
    }

    .name {
        min-width: 150px;
        width: 150px;
        border: var(--border);
        padding: 3px 0 3px 5px;

    }

    .row {
        display: flex;
        flex-direction: row;
        max-width: 150px;
    }

    .rang7 {
        background-color: rgb(0, 160, 160);
    }

    .column {
        width: 45px;
        padding: 2px;
        border: var(--border);
        margin: 0;
        text-align: center;
        min-width: 45px;
    }

    .average {
        min-width: 55px;
        padding: 2px;
        border: var(--border);
        margin: 0;
        text-align: center;
    }

    .rang1 {
        background-color: #8D8D8D;
    }

    .rang2 {
        background-color: rgb(153, 255, 241);

    }

    .rang3 {
        background-color: rgb(163, 255, 153);

    }

    .rang4 {
        background-color: rgb(255, 255, 153);

    }

    .rang5 {
        background-color: rgb(255, 204, 153);

    }

    .rang6 {
        background-color: rgb(255, 153, 204);

    }

    .rang7 {
        background-color: rgb(204, 154, 255);
    }

    .rang8 {
        background-color: rgb(153, 204, 255);

    }

    .rang9 {
        background-color: rgb(20, 26, 135);
        color: rgb(237, 237, 237)
    }

    .competing {}

    .notCompeting {
        filter: brightness(0.7);
        display: none;
    }

    #duels {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        max-width: 730px;
        border: 1px solid black;
        margin: 10px;
    }

    .duelyant {
        font-weight: 1000;
        padding: 10px;
    }

    .duelyant div {
        font-weight: 400;
        width: 160px;
    }

    .won {
        color: rgb(0, 164, 0);
    }

    .lost {
        color: rgb(184, 0, 21);
    }

    .flawlessV {
        color: rgb(0, 21, 209);

    }

    .flawlessL {
        color: rgb(184, 0, 21);
    }

    .hidden {
        display: none;
    }
</style>
<script>
    let selectPass = document.querySelector('#selectPass')
    let selectTop = document.querySelector('#selectTop')
    for (let i = 1; i <= 20; i++) {
        let option = document.createElement('option')
        option.textContent = String(i)
        selectPass.appendChild(option)
        if (i != 20) {
            let option2 = document.createElement('option')
            option2.textContent = String(i)
            selectTop.appendChild(option2)
        }
    }
    let everyone
    function resultsScriptFunction(data, type, quantity = 0, topQuantity) {
        let firstRow = document.querySelector("#firstRow" + type)

        // Создаём первый ряд с количеством заездов
        for (let index = 0; index <= data.length; index++) {
            let div = document.createElement('div')
            firstRow.appendChild(div)
            div.classList.add("column")

            if (index === data.length) {
                div.textContent = "Средн."
                div.classList.add('average')
                continue
            } else {
                div.textContent = index + 1
            }
        }

        // Создаём список всех игроков из всех заездов
        let allPlayers = [...new Set(data.map(race => Object.keys(race)).reduce((a, b) => a.concat(b)))]
        everyone = allPlayers.slice(0)

        // Выделяем список игроков, ранжированный по средней скорости 
        allPlayers = allPlayers.map((player, i) => {
            let averageSpeed = 0, rang = 'rang1'
            let averageSpeedArray = []
            let aboveZero = 0
            data.map((race, index) => {
                if (data[index][player]) {
                    averageSpeed += data[index][player][type.toLowerCase().replace(/percentage/ig, 'Percentage')]
                    averageSpeedArray.push(data[index][player][type.toLowerCase().replace(/percentage/ig, 'Percentage')])
                    rang = data[index][player]["rang"]
                    aboveZero++
                }
            })
            //сколько требуется доездов для зачёта

            if (aboveZero >= quantity) {
                isCompeting = true
            } else {
                isCompeting = false
            }
            // (включая нули) averageSpeed/data.length || (исключая нули) averageSpeed/aboveZero 
            //['sashavirtual', 450.06, 'rang7', 18, true]
            // aboveZero = data.length //раскомментировать если нужно по всем заездам турнира
            if (!isNaN(topQuantity)) {
                return [player, ((averageSpeedArray.slice().sort((a, b) => b - a).slice(0, topQuantity)).reduce((a, b) => a + b) / topQuantity).toFixed(2), rang, aboveZero, isCompeting, (averageSpeedArray.slice().sort((a, b) => b - a).slice(0, topQuantity))]
            }
            return [player, (averageSpeed / aboveZero).toFixed(2), rang, aboveZero, isCompeting]

            //Сортировка по количеству доездов [1] - скорость
        }).sort((a, b) => {
            if (type === 'Speed') {
                return b[1] - a[1]
            } else if (type === 'Errors' || type === "Time" || type === "ErrorPercentage") {
                return a[1] - b[1]
            }
        })
        console.log(allPlayers)
        for (let i = 0; i < allPlayers.length; i++) {
            let tableSpeed = document.querySelector('#table' + type)
            let tr = document.createElement('div')
            let rang = allPlayers[i][2]
            tr.classList.add('row', rang)
            if (!allPlayers[i][4]) {
                tr.classList.add('notCompeting')
            } else {
                tr.classList.add('competing')
            }
            tableSpeed.appendChild(tr)
            let nameElement = document.createElement('div')
            tr.appendChild(nameElement)
            //можно вставить ${i + 1}. 
            nameElement.textContent = `${allPlayers[i][0]}`
            nameElement.classList.add('name', rang)

            // Создаётся массив со скоростями, итерации каждого игрока по объекту с данными
            let speedsArr = []
            for (let j = 0; j <= data.length; j++) {
                if (j == data.length) {
                    let averageSpeed
                    if (!isNaN(topQuantity)) {
                        averageSpeed = (allPlayers[i][5].reduce((a, b) => a + b) / topQuantity).toFixed(2)
                    } else {
                        averageSpeed = (speedsArr.reduce((a, b) => a + b) / allPlayers[i][3]).toFixed(2)
                    }
                    let averageElement = document.createElement('div')
                    tr.appendChild(averageElement)
                    averageElement.textContent = String(averageSpeed)
                    averageElement.classList.add('average', rang)
                    continue
                }
                let raceSpeed
                if (data[j][allPlayers[i][0]]) {
                    raceSpeed = data[j][allPlayers[i][0]][type.toLowerCase().replace(/percentage/ig, 'Percentage')]
                } else {
                    raceSpeed = 0
                }
                speedsArr.push(raceSpeed)
                let speedElement = document.createElement('div')
                tr.appendChild(speedElement)
                speedElement.textContent = String(raceSpeed)
                speedElement.classList.add('column', rang)
            }
        }

        //------------------------------------------------------------------------------//
        if (type === 'Speed') {

            // РЕЗУЛЬТАТЫ ДУЭЛЕЙ
            let allDuels = {}

            // Создаётся обнулённый объект всех возможных дуэлей
            for (let i = 0; i < everyone.length; i++) {
                allDuels[everyone[i]] = {}
                for (let j = 0; j < everyone.length; j++) {
                    if (i !== j) {
                        allDuels[everyone[i]][everyone[j]] = [0, 0];
                    }
                }
            }

            // Объект заполняется данными
            for (let race = 0; race < data.length; race++) {
                for (let plMain = 0; plMain < everyone.length; plMain++) {
                    let pl1 = everyone[plMain]
                    if (data[race][pl1]) {
                        for (let plIterable = plMain + 1; plIterable < everyone.length; plIterable++) {
                            if (plMain !== plIterable) {
                                let pl2 = everyone[plIterable]
                                if (data[race][pl2]) {
                                    let plMS = data[race][everyone[plMain]]["speed"]
                                    let plIS = data[race][everyone[plIterable]]["speed"]
                                    //player Main and Iterable speeds
                                    if (plMS > plIS) {
                                        allDuels[pl1][pl2][0] += 1;
                                        allDuels[pl2][pl1][1] += 1;
                                    } else if (plMS < plIS) {
                                        allDuels[pl1][pl2][1] += 1;
                                        allDuels[pl2][pl1][0] += 1;

                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Данные переносятся на HTML, присваиваются CSS-классы
            for (let i = 0; i < everyone.length; i++) {
                let duels = document.querySelector('#duels')
                let div = document.createElement('div')
                div.classList.add('duelyant')
                div.textContent = everyone[i] + '\n'
                for (const duel in allDuels[everyone[i]]) {
                    let div2 = document.createElement('div')
                    div2.textContent = JSON.stringify(`${duel} (${allDuels[everyone[i]][duel]})`).replace(/[\{\}]/ig, '').replace(/,\"/ig, ",\n\"").replace(/\"/ig, "").replace(',', ':')
                    let res = div2.textContent.replace(/.+\(/ig, ' ').replace(/\)/ig, '').replace(/\s/ig, '').split(':').map(item => +item)
                    if (quantity > res[0] + res[1]) {
                        div2.classList.add('hidden')
                    } else if (res[1] == 0) {
                        div2.classList.add('flawlessV')
                    } else if (res[1] == 15) {
                        div2.classList.add('flawlessL')
                    } else if (res[0] > res[1]) {
                        div2.classList.add('won')
                    } else if (res[1] > res[0]) {
                        div2.classList.add('lost')
                    }
                    if (res[0] === 0 && res[1] === 0) {
                        div2.classList.add('hidden')
                    }
                    div.appendChild(div2)
                }
                let count = 0
                for (let i = 0; i < div.children.length; i++) {
                    if (div.children[i].classList[0] == 'hidden') {
                        count++
                    }
                }
                if (count !== div.children.length) {
                    duels.appendChild(div)
                }
            }

        }
    }

    // Копировать результаты в буфер обмена для Excel
    function copyToClipboard() {
        let id = event.target.id
        let txtArr = [], table
        if (id == 'excelSpeed') {
            table = document.querySelector('#tableSpeed')
        } else if (id == 'excelErrors') {
            table = document.querySelector('#tableErrors')
        } else if (id == 'excelTime') {
            table = document.querySelector('#tableTime')
        } else if (id == 'excelErrorPercentage') {
            table = document.querySelector('#tableErrorPercentage')
        }
        // let row = document.querySelectorAll(".row")
        // console.log(row,'row')
        // console.log(column,'column')
        let i = 0
        for (const row of table.children) {
            txtArr.push(new Array)

            for (const cell of row.children) {
                if (row.length === 0 || row.classList[2] == 'competing' || row.id === 'firstRowSpeed' || row.id === 'firstRowErrors' || row.id === 'firstRowErrorPercentage' || row.id === 'firstRowTime') {
                    txtArr[i].push(cell.textContent)
                }
            }
            if (i) txtArr[i][txtArr[i].length - 1] = txtArr[i][txtArr[i].length - 1]
            // .replace(/.+/ig, `=AVERAGEIF(D${i + 2}:R${i + 2};">0")`)
            txtArr[i] = txtArr[i].join('\t')
            i++
        }
        txtArr = txtArr.filter(item => item)
            .map((item, index) => {
                let tempItem = item.split('\t')
                let tempAverage = tempItem.pop()
                tempItem = tempItem.join('\t').replace(/[\.]/ig, ',')
                if (id === 'excelErrorPercentage' || id === 'excelErrors' || tempAverage === 'Средн.') {
                    tempItem += `\t${tempAverage}`.replace(/[\.]/ig, ',').replace('Средн,', 'Средн.')
                } else {
                    tempItem += `\t=FLOOR.MATH(AVERAGEIF(D21:M21;">0")*100;1)/100`
                }
                return tempItem
            })
        navigator.clipboard.writeText(txtArr.join('\n'))
    }

    document.querySelector('#excelSpeed').addEventListener('click', copyToClipboard)
    document.querySelector('#excelErrors').addEventListener('click', copyToClipboard)
    document.querySelector('#excelTime').addEventListener('click', copyToClipboard)
    document.querySelector('#excelErrorPercentage').addEventListener('click', copyToClipboard)


    function funcCall() {
        let textarea = document.querySelector("body > div.form > textarea").value.replace(/[\n\t\s]/ig, '')
        let data = JSON.parse(`[${textarea.trim()}]`)
        let pass = +document.querySelector("#selectPass").value.replace(/[\n\t\s]/ig, '')
        let topQuantity = +document.querySelector("#selectTop   ").value.replace(/[\n\t\s]/ig, '')
        console.log(isNaN(topQuantity))
        resultsScriptFunction(data, 'Speed', pass, topQuantity)
        resultsScriptFunction(data, 'Errors', pass, topQuantity)
        resultsScriptFunction(data, 'ErrorPercentage', pass, topQuantity)
        resultsScriptFunction(data, 'Time', pass, topQuantity)
        funcCallButton.removeEventListener('click', funcCall)
    }
    let funcCallButton = document.querySelector("#showScores")
    funcCallButton.addEventListener('click', funcCall)
</script>